name: Windows RDP with VSCode

on: workflow_dispatch

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Enable RDP and install tools
      run: |
        echo "==> Preparing system..."
        Set-ExecutionPolicy Bypass -Scope Process -Force
        mkdir C:\Tools -ErrorAction SilentlyContinue

        echo "==> Installing Tailscale..."
        Invoke-WebRequest https://pkgs.tailscale.com/stable/tailscale-setup-latest.exe -OutFile C:\Tools\tailscale.exe
        Start-Process -FilePath C:\Tools\tailscale.exe -ArgumentList "/quiet" -Wait

        echo "==> Installing VS Code..."
        Invoke-WebRequest https://update.code.visualstudio.com/latest/win32-x64-user/stable -OutFile C:\Tools\vscode.exe
        Start-Process -FilePath C:\Tools\vscode.exe -ArgumentList "/VERYSILENT" -Wait

        echo "==> Installing C++ build tools..."
        choco install -y mingw

        echo "==> Installing Python..."
        choco install -y python

        echo "==> Setup done."

    - name: Setup Tailscale Connection
      run: |
        echo "==> Starting Tailscale..."
        Start-Process -FilePath "C:\Program Files (x86)\Tailscale IPN\tailscale.exe" -ArgumentList "up --authkey %TAILSCALE_KEY% --hostname github-runner" -Wait
        echo "Tailscale connected!"

    - name: Display connection info
      run: |
        echo "==> Use your Tailscale IP with port 3389 to connect."
        ipconfig | findstr "IPv4"
